<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo - Tienda PC (Modo Gaming)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --accent1: #061022;
      --accent2: #0b1222;
      --glow: #00d4ff;
      --accent-strong: #0066ff;
      --card-bg: rgba(10,14,39,0.95);
      --muted: #9aa7c7;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,102,255,0.06), transparent 10%),
                  linear-gradient(180deg, var(--accent1) 0%, var(--accent2) 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
    }

    /* NAVBAR */
    .navbar {
      background: linear-gradient(135deg, rgba(0,8,20,0.6), rgba(2,6,20,0.8));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      padding: .9rem 1rem;
      backdrop-filter: blur(6px);
    }
    .navbar-brand {
      font-weight:800;
      letter-spacing: .4px;
      color: white;
    }
    .nav-link { color: rgba(230,238,248,0.85) !important; font-weight:600 }
    .btn-cart {
      background: linear-gradient(90deg, var(--accent-strong), var(--glow));
      border: none;
      border-radius: 999px;
      padding: .45rem .9rem;
      color: white;
      box-shadow: 0 6px 20px rgba(0,102,255,0.12);
    }
    .cart-badge { background: #ff4757; color: white; border-radius: 50%; padding: 0 .45rem; font-weight:700; margin-left:6px }

    /* HERO */
    .hero {
      padding: 2.2rem 0;
      text-align: center;
    }
    .hero h1 { font-size: 2.1rem; font-weight:800; margin-bottom:.3rem; color: #fff; text-shadow: 0 6px 30px rgba(0,0,0,0.6) }
    .hero p { color: var(--muted); margin-bottom: .8rem }

    /* FILTERS */
    .filters { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin: .8rem 0 1.6rem }
    .filter-chip {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.03);
      padding: .45rem .85rem;
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
      font-weight:700;
    }
    .filter-chip.active { background: linear-gradient(90deg,var(--accent-strong),var(--glow)); color: white; box-shadow: 0 8px 30px rgba(0,102,255,0.12) }

    /* CARDS - GRID */
    .product-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: 12px;
      overflow: hidden;
      height: 100%;
      display:flex;
      flex-direction:column;
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 30px 80px rgba(0,0,0,0.6) }
    .product-img {
      padding: 1.25rem;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.05));
      height: 180px;
    }
    .product-img img { max-width:100%; max-height:100%; object-fit:contain; filter: drop-shadow(0 12px 30px rgba(0,102,255,0.06)); }
    .card-body { padding: 1rem; display:flex;flex-direction:column; gap:.5rem; flex:1 }
    .card-title { font-weight:800; color: #ffffff; font-size:1rem }
    .product-specs { display:flex; gap:.4rem; flex-wrap:wrap }
    .spec-badge {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.03);
      padding:.2rem .5rem;
      border-radius:999px;
      color: var(--muted);
      font-weight:700;
      font-size:.8rem;
    }
    .product-price { font-weight:900; font-size:1.15rem; background: linear-gradient(90deg,var(--accent-strong),var(--glow)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-top:auto }

    .btn-add {
      margin-top:.6rem;
      background: linear-gradient(90deg,var(--accent-strong),var(--glow));
      border: none;
      color:white;
      border-radius: 999px;
      padding:.52rem .9rem;
      font-weight:800;
      box-shadow: 0 10px 30px rgba(0,102,255,0.08);
    }

    /* OFFCANVAS */
    .offcanvas { background: linear-gradient(180deg,#071026,#081323); color: #e6eef8; border-left: 1px solid rgba(255,255,255,0.03) }
    .offcanvas-header { border-bottom: 1px solid rgba(255,255,255,0.03); }
    .cart-item { display:flex; gap:.8rem; align-items:center; padding:.6rem; border-radius:10px; background: rgba(255,255,255,0.02); margin-bottom:.6rem }
    .cart-item img { width:56px; height:56px; object-fit:contain; border-radius:8px; background: rgba(255,255,255,0.02); padding:.2rem }

    /* FOOTER */
    footer { text-align:center; padding:1.4rem 0; color:var(--muted); margin-top:2.2rem; border-top: 1px solid rgba(255,255,255,0.02) }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--muted);
    }

    @media (max-width:768px) {
      .product-img { height:140px }
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html"><i class="fas fa-microchip me-2"></i>TIENDA PC</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link active" href="productos.html">Catálogo</a></li>
          <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
        </ul>
        <div class="d-flex align-items-center">
          <button class="btn btn-cart me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer" aria-controls="cartDrawer">
            <i class="fas fa-shopping-cart"></i>
            <span id="cart-count" class="cart-badge">0</span>
          </button>
          <a class="btn btn-sm" href="registro.html" style="color:#cfe9ff; border:1px solid rgba(255,255,255,0.03); border-radius:8px; padding:.45rem .8rem">Acceder</a>
        </div>
      </div>
    </div>
    <div id="user-info" class="d-flex align-items-center"></div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <div class="container">
      <h1>Catálogo — Modo Gaming</h1>
      <p>Procesadores y GPUs — Intel, AMD Ryzen, NVIDIA y AMD. Agrega al carrito y procede al pago.</p>
    </div>
  </header>

  <main class="container my-4">

    <!-- FILTERS -->
    <div class="filters">
      <div class="filter-chip active" data-filter="todos">Todos</div>
      <div class="filter-chip" data-filter="intel">Intel</div>
      <div class="filter-chip" data-filter="ryzen">Ryzen</div>
      <div class="filter-chip" data-filter="nvidia">NVIDIA</div>
      <div class="filter-chip" data-filter="amd">AMD</div>
    </div>

    <!-- PRODUCTOS CONTAINER -->
    <div id="productos-container" class="row g-4">
      <div class="loading">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p class="mt-3">Cargando productos...</p>
      </div>
    </div>

  </main>

  <!-- OFFCANVAS CART -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer" aria-labelledby="cartDrawerLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="cartDrawerLabel"><i class="fas fa-shopping-bag me-2"></i>Tu carrito</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div id="cart-items" class="mb-3"></div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <strong>Total:</strong>
        <strong id="cart-total">S/ 0.00</strong>
      </div>

      <button id="checkout" class="btn btn-primary w-100 mt-3"><i class="fas fa-credit-card me-2"></i>Finalizar compra</button>
    </div>
  </div>

  <footer>
    <div class="container">
      <small>© 2025 Tienda PC — Hardware Profesional</small>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // ========== CONFIGURACIÓN SUPABASE ==========
    const SUPABASE_URL = 'https://vxdfhmakqjmnevmovdhw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4ZGZobWFrcWptbmV2bW92ZGh3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzYxNDAsImV4cCI6MjA4MDIxMjE0MH0.PhpdMBpEs0qGFtGtGYX9mL-Y5EI0qf219VviwETwb4M';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========== VARIABLES GLOBALES ==========
    let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    let todosLosProductos = [];
    let filtroActual = 'todos';

    // ========== FUNCIONES UTILIDAD ==========
    function fmt(n) {
      return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeHtml(str) {
      return (''+str).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // ========== CARGAR PRODUCTOS DESDE SUPABASE ==========
    async function cargarProductos() {
      try {
        const { data: productos, error } = await supabase
          .from('productos')
          .select('*')
          .order('categoria', { ascending: true });

        if (error) throw error;

        todosLosProductos = productos;
        mostrarProductos(productos);
      } catch (error) {
        console.error('Error al cargar productos:', error);
        document.getElementById('productos-container').innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Error al cargar los productos. Verifica tu conexión a Supabase.
              <br><small>${error.message}</small>
            </div>
          </div>
        `;
      }
    }

    // ========== MOSTRAR PRODUCTOS EN LA UI ==========
    function mostrarProductos(productos) {
      const contenedor = document.getElementById('productos-container');
      
      if (productos.length === 0) {
        contenedor.innerHTML = `
          <div class="col-12">
            <p class="text-center text-muted">No hay productos disponibles en esta categoría.</p>
          </div>
        `;
        return;
      }

      contenedor.innerHTML = '';

      productos.forEach(producto => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        
        // Crear badges de especificaciones si existen
        let especificaciones = '';
        if (producto.especificaciones && Array.isArray(producto.especificaciones)) {
          especificaciones = producto.especificaciones.map(spec => 
            `<span class="spec-badge">${spec}</span>`
          ).join('');
        }

        col.innerHTML = `
          <div class="product-card" data-categoria="${producto.categoria || ''}">
            <div class="product-img">
              <img src="${producto.imagen_url || 'img/placeholder.jpg'}" alt="${producto.nombre}">
            </div>
            <div class="card-body">
              <div class="card-title">${producto.nombre}</div>
              ${especificaciones ? `<div class="product-specs">${especificaciones}</div>` : ''}
              <div class="text-muted" style="font-size:.88rem">${producto.descripcion || ''}</div>
              <div class="product-price">S/ ${fmt(producto.precio)}</div>
              <button class="btn-add" 
                      data-id="${producto.id}"
                      data-nombre="${escapeHtml(producto.nombre)}" 
                      data-precio="${producto.precio}" 
                      data-img="${producto.imagen_url || 'img/placeholder.jpg'}"
                      ${producto.stock <= 0 ? 'disabled' : ''}>
                <i class="fas fa-cart-plus me-2"></i>
                ${producto.stock > 0 ? 'Agregar' : 'Sin stock'}
              </button>
              ${producto.stock > 0 && producto.stock <= 5 ? 
                `<small class="text-warning d-block mt-2">¡Solo quedan ${producto.stock}!</small>` : ''}
            </div>
          </div>
        `;
        
        contenedor.appendChild(col);
      });
    }

    // ========== FILTRAR PRODUCTOS ==========
    function filtrarProductos(categoria) {
      filtroActual = categoria;
      
      if (categoria === 'todos') {
        mostrarProductos(todosLosProductos);
      } else {
        const productosFiltrados = todosLosProductos.filter(p => 
          p.categoria && p.categoria.toLowerCase() === categoria.toLowerCase()
        );
        mostrarProductos(productosFiltrados);
      }
    }

    // ========== CARRITO - AÑADIR PRODUCTO ==========
    async function addProductToCart(productoId, nombre, precio, imagen) {
      // Convertir productoId a string para consistencia
      productoId = String(productoId);
      
      // Verificar stock disponible en Supabase
      try {
        const { data: producto, error } = await supabase
          .from('productos')
          .select('stock')
          .eq('id', productoId)
          .single();

        if (error) throw error;

        const cantidadEnCarrito = carrito.find(p => String(p.id) === productoId)?.cantidad || 0;
        
        if (cantidadEnCarrito >= producto.stock) {
          alert('No hay más stock disponible de este producto');
          return false;
        }

        const idx = carrito.findIndex(p => String(p.id) === productoId);
        if (idx >= 0) {
          carrito[idx].cantidad += 1;
        } else {
          carrito.push({ id: productoId, nombre, precio: Number(precio), imagen, cantidad: 1 });
        }
        actualizarCarritoUI();
        return true;
      } catch (error) {
        console.error('Error al verificar stock:', error);
        alert('Error al verificar disponibilidad del producto');
        return false;
      }
    }

    // ========== CARRITO - ACTUALIZAR UI ==========
    function actualizarCarritoUI() {
      const countEl = document.getElementById('cart-count');
      const itemsContainer = document.getElementById('cart-items');
      const totalEl = document.getElementById('cart-total');

      itemsContainer.innerHTML = '';
      const cantidadTotal = carrito.reduce((s, p) => s + p.cantidad, 0);
      countEl.textContent = cantidadTotal;

      if (carrito.length === 0) {
        itemsContainer.innerHTML = '<p class="text-muted">Tu carrito está vacío.</p>';
        totalEl.textContent = 'S/ 0.00';
        localStorage.setItem('carrito', JSON.stringify(carrito));
        localStorage.setItem('totalCarrito', (0).toFixed(2));
        return;
      }

      let total = 0;
      carrito.forEach(p => {
        const subtotal = p.precio * p.cantidad;
        total += subtotal;

        const item = document.createElement('div');
        item.className = 'cart-item';
        item.innerHTML = `
          <img src="${p.imagen}" alt="${p.nombre}">
          <div style="flex:1">
            <div style="font-weight:800; font-size:.95rem">${p.nombre}</div>
            <div style="color:var(--muted); font-size:.85rem">S/ ${fmt(p.precio)} x ${p.cantidad}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">S/ ${fmt(subtotal)}</div>
            <div class="mt-2 d-flex justify-content-end align-items-center">
              <button class="btn btn-sm qty-btn-decrease" data-id="${p.id}">−</button>
              <div style="width:8px"></div>
              <button class="btn btn-sm qty-btn-increase" data-id="${p.id}">+</button>
              <button class="btn btn-sm btn-outline-danger ms-2 btn-remove" data-id="${p.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        itemsContainer.appendChild(item);
      });

      totalEl.textContent = 'S/ ' + fmt(total);
      localStorage.setItem('carrito', JSON.stringify(carrito));
      localStorage.setItem('totalCarrito', total.toFixed(2));

      // Event listeners para botones del carrito
      document.querySelectorAll('.qty-btn-increase').forEach(btn => {
        btn.addEventListener('click', () => changeQty(btn.dataset.id, +1));
      });
      document.querySelectorAll('.qty-btn-decrease').forEach(btn => {
        btn.addEventListener('click', () => changeQty(btn.dataset.id, -1));
      });
      document.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', () => removeItem(btn.dataset.id));
      });
    }

    // ========== CARRITO - CAMBIAR CANTIDAD ==========
    async function changeQty(productoId, delta) {
      // Convertir productoId a string para comparación consistente
      productoId = String(productoId);
      console.log('changeQty llamado con ID:', productoId, 'delta:', delta);
      console.log('Carrito actual:', carrito);
      
      const idx = carrito.findIndex(p => String(p.id) === productoId);
      console.log('Índice encontrado:', idx);
      
      if (idx === -1) {
        console.error('Producto no encontrado en carrito');
        return;
      }

      const nuevaCantidad = carrito[idx].cantidad + delta;

      // Si disminuye a 0 o menos, eliminar
      if (nuevaCantidad <= 0) {
        carrito.splice(idx, 1);
        actualizarCarritoUI();
        return;
      }

      // Si aumenta, verificar stock
      if (delta > 0) {
        try {
          const { data: producto, error } = await supabase
            .from('productos')
            .select('stock')
            .eq('id', productoId)
            .single();

          if (error) throw error;

          if (nuevaCantidad > producto.stock) {
            alert('No hay suficiente stock disponible');
            return;
          }
        } catch (error) {
          console.error('Error al verificar stock:', error);
          return;
        }
      }

      carrito[idx].cantidad = nuevaCantidad;
      actualizarCarritoUI();
    }

    // ========== CARRITO - ELIMINAR ITEM ==========
    function removeItem(productoId) {
      // Convertir productoId a string para comparación consistente
      productoId = String(productoId);
      console.log('removeItem llamado con ID:', productoId);
      console.log('Carrito antes de eliminar:', carrito);
      
      const longitudAntes = carrito.length;
      carrito = carrito.filter(p => String(p.id) !== productoId);
      
      console.log('Carrito después de eliminar:', carrito);
      console.log('Items eliminados:', longitudAntes - carrito.length);
      
      actualizarCarritoUI();
    }

    // ========== EVENT LISTENERS ==========
    
    // Agregar al carrito
    document.addEventListener('click', async function(e) {
      const btn = e.target.closest('.btn-add');
      if (!btn || btn.disabled) return;
      
      const productoId = btn.dataset.id;
      const nombre = btn.dataset.nombre;
      const precio = Number(btn.dataset.precio);
      const img = btn.dataset.img || 'img/placeholder.jpg';
      
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
      btn.disabled = true;

      const agregado = await addProductToCart(productoId, nombre, precio, img);

      if (agregado) {
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Agregado';
        setTimeout(() => { 
          btn.innerHTML = original; 
          btn.disabled = false; 
        }, 700);
      } else {
        btn.innerHTML = original;
        btn.disabled = false;
      }
    });

    // Filtros
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', function() {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        const filter = this.dataset.filter;
        filtrarProductos(filter);
      });
    });

    // Checkout
    document.getElementById('checkout').addEventListener('click', async function() {
      const recalTotal = carrito.reduce((s,p)=> s + p.precio*p.cantidad, 0);
      localStorage.setItem('totalCarrito', recalTotal.toFixed(2));
      localStorage.setItem('carrito', JSON.stringify(carrito));

      if (carrito.length === 0) {
        alert('Tu carrito está vacío. Agrega productos antes de pagar.');
        return;
      }

      const usuario = localStorage.getItem('usuarioActivo');
      if (!usuario) {
        if (confirm('Para finalizar la compra necesitas iniciar sesión o registrarte. ¿Ir a registro ahora?')) {
          window.location.href = 'registro.html';
        }
        return;
      }

      // Confirmar compra
      if (!confirm(`¿Confirmar compra por S/ ${fmt(recalTotal)}?`)) {
        return;
      }

      // Actualizar stock en Supabase
      try {
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando compra...';
        this.disabled = true;

        console.log('Iniciando actualización de stock para:', carrito);

        for (const item of carrito) {
          const productoId = String(item.id);
          console.log(`Procesando producto ID: ${productoId}, cantidad a restar: ${item.cantidad}`);
          
          // Obtener stock actual
          const { data: producto, error: errorGet } = await supabase
            .from('productos')
            .select('stock')
            .eq('id', productoId)
            .single();

          if (errorGet) {
            console.error('Error al obtener stock:', errorGet);
            throw errorGet;
          }

          console.log(`Stock actual de ${item.nombre}: ${producto.stock}`);

          const nuevoStock = producto.stock - item.cantidad;

          if (nuevoStock < 0) {
            throw new Error(`No hay suficiente stock de ${item.nombre}`);
          }

          console.log(`Nuevo stock será: ${nuevoStock}`);

          // Actualizar stock
          const { data: dataUpdate, error: errorUpdate } = await supabase
            .from('productos')
            .update({ stock: nuevoStock })
            .eq('id', productoId)
            .select();

          if (errorUpdate) {
            console.error('Error al actualizar stock:', errorUpdate);
            throw errorUpdate;
          }

          console.log('Stock actualizado exitosamente:', dataUpdate);
        }

        // Limpiar carrito
        carrito = [];
        localStorage.removeItem('carrito');
        localStorage.setItem('totalCarrito', (0).toFixed(2));
        actualizarCarritoUI();

        // Recargar productos para mostrar stock actualizado
        await cargarProductos();

        alert('¡Compra realizada con éxito! El stock ha sido actualizado.');
        
        // Cerrar offcanvas
        const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('cartDrawer'));
        if (offcanvas) offcanvas.hide();

      } catch (error) {
        console.error('Error al procesar compra:', error);
        alert('Error al procesar la compra: ' + error.message);
      } finally {
        this.innerHTML = '<i class="fas fa-credit-card me-2"></i>Finalizar compra';
        this.disabled = false;
      }
    });

    // Actualizar carrito al abrir offcanvas
    const cartDrawer = document.getElementById('cartDrawer');
    cartDrawer.addEventListener('show.bs.offcanvas', function () {
      carrito = JSON.parse(localStorage.getItem('carrito')) || carrito;
      actualizarCarritoUI();
    });

    // ========== INICIALIZACIÓN ==========
    document.addEventListener('DOMContentLoaded', function() {
      cargarProductos();
      actualizarCarritoUI();
    });

  </script>
  <script src="auth.js"></script>
</body>
</html>